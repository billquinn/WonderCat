---
output:
  reprex::reprex_document:
    venue: "gh"
    advertise: FALSE
    session_info: TRUE
    style: TRUE
    comment: "#;-)"
    tidyverse_quiet: FALSE
    std_out_err: TRUE
knit: reprex::reprex_render
---

# WonderCat

```{r}
library(tidyverse)
library(shiny)
library(httr2)
library(jsonlite)
library(dplyr)
library(bslib)
library(DT)
library(ggplot2)
library(ggraph)
library(igraph)
library(plotly)
library(treemap)

print (getwd())
# Import functions.
source(paste0(getwd(), 'Documents/DH/GitHub/WonderCat/WonderCat', '/functions.R'))
```

## API Call

NEED TO PULL DATA FROM EACH PAGE; CURRENTLY PULLING FROM ONLY FIRST PAGE!!!!
```{r}

WP_USER <- 'bill.quinn@marist.edu'
WP_KEY <- 'f45D rE4U BoIR w6xq Yle7 ktEE'
API_prefix <- "https://env-1120817.us.reclaim.cloud/wp-json/wp/v2/user-experience"

req <- request(API_prefix)

resp <- req |> req_perform() |> resp_body_json(check_type = TRUE, simplifyVector = TRUE)
```

## Create DataFrame
```{r}
# Clean Up Dataframe
clean_up_dataframe <- function(data){
  dataframe <- data %>% 
    select(id, author, date, benefit, experience, technology, acf) %>% 
    unnest(c(benefit, experience, technology, acf), names_sep = '.') %>%
    select(
      id, author, date, 
      benefit.name, experience.name, technology.name, 
      acf.title_of_creative_work, starts_with('acf.wikidata-qid')
      )
  
  colnames(dataframe) <- c(
    'id', 'author', 'date', 'benefit', 'experience', 'technology', 'title', 'QID'
  )
  
  return (dataframe)
}

dataframe <- clean_up_dataframe(resp)
```

### Bar Plot
```{r}
bar_data <- dataframe %>% count(technology)

p <- bar_data |>
      ggplot(aes(x = n, y = technology, fill = technology)) +
      geom_bar(stat = "identity")

ggplotly(p)
```

### Tree Map
```{r}
treeData <-  dataframe %>% group_by(title, experience) %>% summarize(count = n())
#treemap(treeData, index = c("title", "experience"), vSize="count", type="index")

t <- plot_ly(data = treeData, branchvalues = "total", type = "treemap", 
             parents = ~title, labels = ~experience, values = ~count)

#ggplotly(t)
t <- plot_ly(data = G20, branchvalues = "total", type = "treemap", 
             parents = ~region, labels = ~country, values = ~gdp_mil_usd)

t
```

```{r}
library(treemapify)

G20 <- G20

p <- ggplot(treeData, aes(area = count, fill = experience, label = title)) +
  geom_treemap() +
  geom_treemap_text(place = "center")

p
#ggplotly(p)
```

```{r}
# https://www.codingthepast.com/2024/05/09/Treemaps-in-R.html
library(treemap)
library(HistData)

data("Cholera")

treemap(Cholera,
        index=c("region","district"),
        vSize="cholera_deaths",
        vColor = "region",
        type = "categorical",
        # formatting options:
        #palette = brewer.pal(n = 5, name = "Accent"),
        align.labels=list(
          c("left", "top"), 
          c("right", "bottom")
        ),     
        border.col = "white",
        bg.labels = 255,
        position.legend = "none")
```


```{r}
treemap(treeData,
        index=c("experience","title"),
        vSize="count",
        vColor = "experience",
        type = "categorical",
        # formatting options:
        #palette = brewer.pal(n = 5, name = "Accent"),
        align.labels=list(
          c("left", "top"), 
          c("right", "bottom")
        ),     
        border.col = "white",
        bg.labels = 255,
        position.legend = "none")
```
